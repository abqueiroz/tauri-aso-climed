{"version":3,"sources":["../src/index.ts","../src/db.ts","../src/schema.ts"],"sourcesContent":["import express from 'express';\nimport cors, { CorsOptions } from 'cors';\nimport { nanoid } from 'nanoid';\nimport { z } from 'zod';\nimport puppeteer from 'puppeteer';\n\nimport { getDb } from './db';\nimport { todos } from './schema';\nimport { like, sql } from 'drizzle-orm';\n\nconst PORT = 14222;\nconst app = express();\n\napp.use(express.json({ limit: '1mb' }));\n\n// CORS restrito\nconst allowedOrigins = new Set([\n  'http://localhost:1420',\n  'http://127.0.0.1:1420',\n  'tauri://localhost',\n  'https://tauri.localhost',\n]);\n\nconst corsOptions: CorsOptions = {\n  origin(origin, cb) {\n    if (!origin) return cb(null, true); // chamadas internas (reqwest do Rust, Postman)\n    if (allowedOrigins.has(origin)) return cb(null, true);\n    return cb(new Error(`CORS blocked for origin: ${origin}`));\n  },\n  methods: ['GET', 'POST', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization'],\n  maxAge: 600,\n};\n\napp.use(cors(corsOptions));\napp.options('*', cors(corsOptions));\n\nconst db = getDb();\n\nconst CreateTodo = z.object({\n  title: z.string().min(2),\n  notes: z.string().optional(),\n});\n\napp.get('/health', (_req, res) => res.json({ ok: true }));\n\napp.get('/api/todos', async (req, res) => {\n  try {\n    const exportMode = String(req.query.export ?? '');\n    const search = String(req.query.search ?? '').trim();\n\n    const where = search\n      ? like(todos.title, `%${search.replaceAll('%', '\\\\%').replaceAll('_', '\\\\_')}%`)\n      : undefined;\n\n    const rows = await db.select().from(todos).where(where).orderBy(sql`${todos.createdAt} DESC`);\n\n    if (exportMode === 'pdf') {\n      const html = renderHtml(rows);\n      const pdfBase64 = await htmlToPdfBase64(html);\n      return res.json({ pdfBase64 });\n    }\n\n    return res.json(rows);\n  } catch (e: any) {\n    return res.status(500).send(e?.message ?? String(e));\n  }\n});\n\napp.post('/api/todos', async (req, res) => {\n  try {\n    const parsed = CreateTodo.safeParse(req.body);\n    if (!parsed.success) return res.status(400).json(parsed.error.flatten());\n\n    const item = {\n      id: nanoid(),\n      title: parsed.data.title,\n      notes: parsed.data.notes ?? null,\n      createdAt: Date.now(),\n    };\n\n    await db.insert(todos).values(item);\n    return res.status(201).json(item);\n  } catch (e: any) {\n    return res.status(500).send(e?.message ?? String(e));\n  }\n});\n\napp.delete('/api/todos', async (req, res) => {\n  try {\n    const id = String(req.query.id ?? '').trim();\n    if (!id) return res.status(400).send('query param \"id\" é obrigatório');\n\n    await db.delete(todos).where(sql`${todos.id} = ${id}`);\n    return res.json({ ok: true });\n  } catch (e: any) {\n    return res.status(500).send(e?.message ?? String(e));\n  }\n});\n\napp.listen(PORT, '127.0.0.1', () => {\n  console.log(`[sidecar] listening on http://127.0.0.1:${PORT}`);\n});\n\nfunction renderHtml(rows: Array<{ id: string; title: string; notes: string | null; createdAt: number }>) {\n  const items = rows.map(r => `\n    <tr>\n      <td>${escapeHtml(r.title)}</td>\n      <td>${escapeHtml(r.notes ?? '')}</td>\n      <td>${new Date(r.createdAt).toLocaleString()}</td>\n    </tr>\n  `).join('');\n\n  return `<!doctype html>\n  <html><head><meta charset=\"utf-8\" />\n  <style>\n    body{font-family:Arial,sans-serif;padding:24px}\n    table{width:100%;border-collapse:collapse}\n    th,td{border:1px solid #ddd;padding:8px;font-size:12px}\n    th{background:#f4f4f4;text-align:left}\n    .meta{color:#666;margin-bottom:16px;font-size:12px}\n  </style>\n  </head>\n  <body>\n    <h1>Relatório de Itens</h1>\n    <div class=\"meta\">Gerado em ${new Date().toLocaleString()}</div>\n    <table>\n      <thead><tr><th>Título</th><th>Notas</th><th>Criado em</th></tr></thead>\n      <tbody>${items || '<tr><td colspan=\"3\">Sem itens</td></tr>'}</tbody>\n    </table>\n  </body></html>`;\n}\n\nfunction escapeHtml(s: string) {\n  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;').replaceAll(\"'\",\"&#039;\");\n}\n\nasync function htmlToPdfBase64(html: string) {\n  const browser = await puppeteer.launch({ headless: 'new', args: ['--no-sandbox', '--disable-setuid-sandbox'] });\n  try {\n    const page = await browser.newPage();\n    await page.setContent(html, { waitUntil: 'networkidle0' });\n    const pdf = await page.pdf({ format: 'A4', printBackground: true });\n    return Buffer.from(pdf).toString('base64');\n  } finally {\n    await browser.close();\n  }\n}\n","import os from 'node:os';\nimport path from 'node:path';\nimport fs from 'node:fs';\n\nimport Database from 'better-sqlite3';\nimport { drizzle } from 'drizzle-orm/better-sqlite3';\nimport { todos } from './schema';\n\nexport function getDb() {\n  const dir = path.join(os.homedir(), '.tauri-hybrid-demo');\n  fs.mkdirSync(dir, { recursive: true });\n\n  const dbPath = path.join(dir, 'app.sqlite');\n  const sqlite = new Database(dbPath);\n\n  sqlite.exec(`\n    CREATE TABLE IF NOT EXISTS todos (\n      id TEXT PRIMARY KEY NOT NULL,\n      title TEXT NOT NULL,\n      notes TEXT,\n      created_at INTEGER NOT NULL\n    );\n  `);\n\n  return drizzle(sqlite, { schema: { todos } });\n}\n","import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';\n\nexport const todos = sqliteTable('todos', {\n  id: text('id').primaryKey(),\n  title: text('title').notNull(),\n  notes: text('notes'),\n  createdAt: integer('created_at', { mode: 'number' }).notNull(),\n});\n"],"mappings":"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","names":["import_better_sqlite3","path","os","fs","Database","express","cors","puppeteer"]}